version: '3.8'

# Multi-node cluster configuration for Stage 3 distributed datalake
# This configuration creates 3 ingestion nodes with cross-replication

services:

  # ============== Message Broker ==============
  activemq:
    image: apache/activemq-classic:5.18.3
    container_name: stage3-activemq
    ports:
      - "61616:61616"
      - "8161:8161"
    environment:
      - ACTIVEMQ_ADMIN_LOGIN=admin
      - ACTIVEMQ_ADMIN_PASSWORD=admin
    volumes:
      - activemq-data:/opt/apache-activemq/data
    networks:
      - stage3-cluster
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8161/admin"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============== Ingestion Nodes ==============
  
  ingestion-node-1:
    build:
      context: ../ingestion-service
      dockerfile: Dockerfile
    container_name: ingestion-node-1
    ports:
      - "7001:7001"
    environment:
      - SERVER_PORT=7001
      - NODE_ID=ingestion-node-1
      - DATALAKE_DIR=/data/datalake
      - BROKER_URL=tcp://activemq:61616
      - BROKER_ENABLED=true
      - DATALAKE_REPLICATION_FACTOR=2
      - DATALAKE_PEERS=http://ingestion-node-2:7001,http://ingestion-node-3:7001
    volumes:
      - node1-datalake:/data/datalake
    networks:
      - stage3-cluster
    depends_on:
      - activemq

  ingestion-node-2:
    build:
      context: ../ingestion-service
      dockerfile: Dockerfile
    container_name: ingestion-node-2
    ports:
      - "7011:7001"
    environment:
      - SERVER_PORT=7001
      - NODE_ID=ingestion-node-2
      - DATALAKE_DIR=/data/datalake
      - BROKER_URL=tcp://activemq:61616
      - BROKER_ENABLED=true
      - DATALAKE_REPLICATION_FACTOR=2
      - DATALAKE_PEERS=http://ingestion-node-1:7001,http://ingestion-node-3:7001
    volumes:
      - node2-datalake:/data/datalake
    networks:
      - stage3-cluster
    depends_on:
      - activemq

  ingestion-node-3:
    build:
      context: ../ingestion-service
      dockerfile: Dockerfile
    container_name: ingestion-node-3
    ports:
      - "7021:7001"
    environment:
      - SERVER_PORT=7001
      - NODE_ID=ingestion-node-3
      - DATALAKE_DIR=/data/datalake
      - BROKER_URL=tcp://activemq:61616
      - BROKER_ENABLED=true
      - DATALAKE_REPLICATION_FACTOR=2
      - DATALAKE_PEERS=http://ingestion-node-1:7001,http://ingestion-node-2:7001
    volumes:
      - node3-datalake:/data/datalake
    networks:
      - stage3-cluster
    depends_on:
      - activemq

  # ============== Indexer Service ==============
  
  indexer:
    build:
      context: ../indexer-service
      dockerfile: Dockerfile
    container_name: stage3-indexer
    ports:
      - "7002:7002"
    environment:
      - SERVER_PORT=7002
      - NODE_ID=indexer-node-1
      - BROKER_URL=tcp://activemq:61616
      - BROKER_ENABLED=true
      - DATALAKE_PATH=/data/datalake
    volumes:
      - indexer-data:/data
    networks:
      - stage3-cluster
    depends_on:
      - activemq

  # ============== Search Service ==============

  search:
    build:
      context: ../search-service
      dockerfile: Dockerfile
    container_name: stage3-search
    ports:
      - "7003:7003"
    environment:
      - SERVER_PORT=7003
      - NODE_ID=search-node-1
    volumes:
      - search-data:/data
    networks:
      - stage3-cluster

volumes:
  activemq-data:
  node1-datalake:
  node2-datalake:
  node3-datalake:
  indexer-data:
  search-data:

networks:
  stage3-cluster:
    driver: bridge
