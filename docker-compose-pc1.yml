version: '3.8'

# Multi-host (3 PCs) - PC1
# Run on PC1 only. Requires a .env with PC1_IP, PC2_IP, PC3_IP.

services:
  activemq:
    image: apache/activemq-classic:5.18.3
    container_name: activemq-broker
    ports:
      - "61616:61616"
      - "8161:8161"
      - "5672:5672"
    environment:
      - ACTIVEMQ_ADMIN_LOGIN=admin
      - ACTIVEMQ_ADMIN_PASSWORD=admin
    volumes:
      - activemq-data:/opt/activemq/data
    restart: unless-stopped

  hazelcast-1:
    image: hazelcast/hazelcast:5.3.6
    container_name: hazelcast-1
    ports:
      - "5701:5701"
    environment:
      - HZ_CLUSTERNAME=stage3-cluster
      - HZ_NETWORK_JOIN_TCPIP_ENABLED=true
      - HZ_NETWORK_JOIN_MULTICAST_ENABLED=false
      - HZ_NETWORK_JOIN_TCPIP_MEMBERS=${PC1_IP}:5701,${PC2_IP}:5701,${PC3_IP}:5701
      - HZ_NETWORK_PUBLICADDRESS=${PC1_IP}:5701
      - JAVA_OPTS=-Xms256m -Xmx512m -Dhazelcast.local.publicAddress=${PC1_IP}:5701
    volumes:
      - hazelcast-data-1:/opt/hazelcast/data
    restart: unless-stopped

  ingestion-1:
    build:
      context: .
      dockerfile: ingestion-service/Dockerfile
    container_name: ingestion-1
    ports:
      - "7001:7001"
    environment:
      - NODE_ID=ingestion-1
      - SERVER_PORT=7001
      - BROKER_ENABLED=true
      - BROKER_URL=tcp://${PC1_IP}:61616
      - DATALAKE_DIR=/app/datalake
      - DATALAKE_REPLICATION_FACTOR=3
      - DATALAKE_PEERS=http://${PC2_IP}:7001,http://${PC3_IP}:7001
    volumes:
      - datalake:/app/datalake
    depends_on:
      - activemq
    restart: unless-stopped

  indexer-1:
    build:
      context: .
      dockerfile: indexer-service/Dockerfile
    container_name: indexer-1
    ports:
      - "7002:7002"
    environment:
      - NODE_ID=indexer-1
      - SERVER_PORT=7002
      - BROKER_ENABLED=true
      - BROKER_URL=tcp://${PC1_IP}:61616
      - HAZELCAST_ENABLED=true
      - HAZELCAST_CLUSTER_NAME=stage3-cluster
      - HAZELCAST_MEMBERS=${PC1_IP}:5701,${PC2_IP}:5701,${PC3_IP}:5701
      - DATALAKE_PATH=/app/datalake
      - DB_PATH=/app/datamart/datamart.db
      - INDEX_OUTPUT_DIR=/app/indexer/tsv-index
      - CATALOG_OUTPUT_PATH=/app/metadata/catalog.json
      - LEGACY_TSV_ENABLED=false
    volumes:
      - datalake:/app/datalake
      - index:/app/indexer
      - datamart:/app/datamart
      - metadata:/app/metadata
    depends_on:
      - activemq
      - hazelcast-1
    restart: unless-stopped

  search-1:
    build:
      context: .
      dockerfile: search-service/Dockerfile
    container_name: search-1
    ports:
      - "7003:7003"
    environment:
      - NODE_ID=search-1
      - SERVER_PORT=7003
      - HAZELCAST_ENABLED=true
      - HAZELCAST_CLUSTER_NAME=stage3-cluster
      - HAZELCAST_MEMBERS=${PC1_IP}:5701,${PC2_IP}:5701,${PC3_IP}:5701
      - INDEX_PATH=/app/indexer/tsv-index
      - DB_PATH=/app/datamart/datamart.db
    volumes:
      - index:/app/indexer:ro
      - datamart:/app/datamart:ro
    depends_on:
      - hazelcast-1
    restart: unless-stopped

  nginx:
    image: nginx:1.25-alpine
    container_name: nginx-lb
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.multihost.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - ingestion-1
      - indexer-1
      - search-1
    restart: unless-stopped

volumes:
  activemq-data:
  hazelcast-data-1:
  datalake:
  index:
  datamart:
  metadata:
