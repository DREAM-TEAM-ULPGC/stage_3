# Nginx Load Balancer Configuration (Multi-host / 3 PCs)
# Replace PC1_IP / PC2_IP / PC3_IP with your real LAN IPs.

# Example:
# upstream ingestion_upstream { server 192.168.1.10:7001; server 192.168.1.11:7001; server 192.168.1.12:7001; }

worker_processes  1;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  keepalive_timeout  65;

  # Upstreams (multi-host)
  upstream ingestion_upstream {
    server PC1_IP:7001;
    server PC2_IP:7001;
    server PC3_IP:7001;
    server PC4_IP:7001;
    server PC5_IP:7001;
    server PC6_IP:7001;
  }

  upstream indexer_upstream {
    server PC1_IP:7002;
    server PC2_IP:7002;
    server PC3_IP:7002;
    server PC4_IP:7002;
    server PC5_IP:7002;
    server PC6_IP:7002;
  }

  upstream search_upstream {
    server PC1_IP:7003;
    server PC2_IP:7003;
    server PC3_IP:7003;
    server PC4_IP:7003;
    server PC5_IP:7003;
    server PC6_IP:7003;
  }

  server {
    listen 80;
    server_name _;

    location /nginx/health {
      access_log off;
      return 200 '{"status":"ok","service":"nginx-lb"}';
      add_header Content-Type application/json;
    }

    # Ingestion
    location /ingestion/ {
      rewrite ^/ingestion/(.*)$ /$1 break;
      proxy_pass http://ingestion_upstream;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Indexer
    location /indexer/ {
      rewrite ^/indexer/(.*)$ /$1 break;
      proxy_pass http://indexer_upstream;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Search (distributed by default; clients can still call /search/distributed)
    location /search {
      proxy_pass http://search_upstream;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /book/ {
      proxy_pass http://search_upstream;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location = /health {
      proxy_pass http://search_upstream/health;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      access_log off;
    }

    location = /status {
      proxy_pass http://search_upstream/status;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      access_log off;
    }

    location / {
      return 404 '{"error":"not_found"}';
      add_header Content-Type application/json;
    }
  }
}
