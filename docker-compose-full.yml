version: '3.8'

# =============================================================================
# Docker Compose - Complete Distributed Gutenberg System with Nginx Load Balancer
# Stage 3 - Distributed Architecture
# =============================================================================
# 
# Architecture:
#   - Nginx Load Balancer (port 80)
#   - ActiveMQ Message Broker (port 61616, 8161)
#   - Hazelcast Cluster (3 nodes, ports 5701-5703)
#   - Ingestion Service (2 replicas)
#   - Indexer Service (2 replicas)
#   - Search Service (3 replicas)
#
# Usage:
#   docker-compose -f docker-compose-full.yml up -d
#   docker-compose -f docker-compose-full.yml logs -f
#   docker-compose -f docker-compose-full.yml down
# =============================================================================

services:

  # ===========================================================================
  # NGINX LOAD BALANCER
  # ===========================================================================
  
  nginx:
    image: nginx:1.25-alpine
    container_name: nginx-lb
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/logs:/var/log/nginx
    networks:
      - gutenberg-network
    # Nginx will retry connecting to upstreams, no strict dependencies needed
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # MESSAGE BROKER - ActiveMQ
  # ===========================================================================
  
  activemq:
    image: apache/activemq-classic:5.18.3
    container_name: activemq-broker
    ports:
      - "61616:61616"  # OpenWire
      - "8161:8161"    # Web Console
      - "5672:5672"    # AMQP
    environment:
      - ACTIVEMQ_ADMIN_LOGIN=admin
      - ACTIVEMQ_ADMIN_PASSWORD=admin
    volumes:
      - activemq-data:/opt/activemq/data
    networks:
      - gutenberg-network
    healthcheck:
      test: ["CMD", "curl", "-f", "-u", "admin:admin", "http://localhost:8161/admin/"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # HAZELCAST CLUSTER (3 nodes for quorum)
  # ===========================================================================
  
  hazelcast-1:
    image: hazelcast/hazelcast:5.3.6
    container_name: hazelcast-1
    hostname: hazelcast-1
    ports:
      - "5701:5701"
    environment:
      - HZ_CLUSTERNAME=stage3-cluster
      - HZ_NETWORK_JOIN_TCPIP_ENABLED=true
      - HZ_NETWORK_JOIN_MULTICAST_ENABLED=false
      - HZ_NETWORK_JOIN_TCPIP_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - HZ_NETWORK_PUBLICADDRESS=hazelcast-1:5701
      - HZ_NETWORK_INTERFACES_ENABLED=false
      - JAVA_OPTS=-Xms256m -Xmx512m -Dhazelcast.local.publicAddress=hazelcast-1:5701 -Dhazelcast.socket.bind.any=false
    volumes:
      - hazelcast-data-1:/opt/hazelcast/data
    networks:
      - gutenberg-network
    restart: unless-stopped

  hazelcast-2:
    image: hazelcast/hazelcast:5.3.6
    container_name: hazelcast-2
    hostname: hazelcast-2
    ports:
      - "5702:5701"
    environment:
      - HZ_CLUSTERNAME=stage3-cluster
      - HZ_NETWORK_JOIN_TCPIP_ENABLED=true
      - HZ_NETWORK_JOIN_MULTICAST_ENABLED=false
      - HZ_NETWORK_JOIN_TCPIP_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - HZ_NETWORK_PUBLICADDRESS=hazelcast-2:5701
      - HZ_NETWORK_INTERFACES_ENABLED=false
      - JAVA_OPTS=-Xms256m -Xmx512m -Dhazelcast.local.publicAddress=hazelcast-2:5701 -Dhazelcast.socket.bind.any=false
    volumes:
      - hazelcast-data-2:/opt/hazelcast/data
    networks:
      - gutenberg-network
    depends_on:
      - hazelcast-1
    restart: unless-stopped

  hazelcast-3:
    image: hazelcast/hazelcast:5.3.6
    container_name: hazelcast-3
    hostname: hazelcast-3
    ports:
      - "5703:5701"
    environment:
      - HZ_CLUSTERNAME=stage3-cluster
      - HZ_NETWORK_JOIN_TCPIP_ENABLED=true
      - HZ_NETWORK_JOIN_MULTICAST_ENABLED=false
      - HZ_NETWORK_JOIN_TCPIP_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - HZ_NETWORK_PUBLICADDRESS=hazelcast-3:5701
      - HZ_NETWORK_INTERFACES_ENABLED=false
      - JAVA_OPTS=-Xms256m -Xmx512m -Dhazelcast.local.publicAddress=hazelcast-3:5701 -Dhazelcast.socket.bind.any=false
    volumes:
      - hazelcast-data-3:/opt/hazelcast/data
    networks:
      - gutenberg-network
    depends_on:
      - hazelcast-2
    restart: unless-stopped

  # ===========================================================================
  # INGESTION SERVICE CLUSTER (2 replicas)
  # ===========================================================================
  
  ingestion-1:
    build:
      context: .
      dockerfile: ingestion-service/Dockerfile
    container_name: ingestion-1
    environment:
      - NODE_ID=ingestion-1
      - SERVER_PORT=7001
      - BROKER_ENABLED=true
      - BROKER_URL=tcp://activemq:61616
      - DATALAKE_DIR=/app/datalake
      - DATALAKE_PEERS=http://ingestion-2:7001
      - DATALAKE_REPLICATION_FACTOR=2
    volumes:
      - shared-datalake:/app/datalake
    networks:
      - gutenberg-network
    depends_on:
      - activemq
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/status"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  ingestion-2:
    build:
      context: .
      dockerfile: ingestion-service/Dockerfile
    container_name: ingestion-2
    environment:
      - NODE_ID=ingestion-2
      - SERVER_PORT=7001
      - BROKER_ENABLED=true
      - BROKER_URL=tcp://activemq:61616
      - DATALAKE_DIR=/app/datalake
      - DATALAKE_PEERS=http://ingestion-1:7001
      - DATALAKE_REPLICATION_FACTOR=2
    volumes:
      - shared-datalake:/app/datalake
    networks:
      - gutenberg-network
    depends_on:
      - activemq
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/status"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ===========================================================================
  # INDEXER SERVICE CLUSTER (2 replicas)
  # ===========================================================================
  
  indexer-1:
    build:
      context: .
      dockerfile: indexer-service/Dockerfile
    container_name: indexer-1
    environment:
      - NODE_ID=indexer-1
      - SERVER_PORT=7002
      - BROKER_ENABLED=true
      - BROKER_URL=tcp://activemq:61616
      - HAZELCAST_ENABLED=true
      - HAZELCAST_CLUSTER_NAME=stage3-cluster
      - HAZELCAST_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - DATALAKE_PATH=/app/datalake
      - DB_PATH=/app/datamart/datamart.db
    volumes:
      - shared-datalake:/app/datalake
      - shared-index:/app/indexer
      - shared-datamart:/app/datamart
      - shared-metadata:/app/metadata
    networks:
      - gutenberg-network
    depends_on:
      - activemq
      - hazelcast-1
      - hazelcast-2
      - hazelcast-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7002/status"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  indexer-2:
    build:
      context: .
      dockerfile: indexer-service/Dockerfile
    container_name: indexer-2
    environment:
      - NODE_ID=indexer-2
      - SERVER_PORT=7002
      - BROKER_ENABLED=true
      - BROKER_URL=tcp://activemq:61616
      - HAZELCAST_ENABLED=true
      - HAZELCAST_CLUSTER_NAME=stage3-cluster
      - HAZELCAST_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - DATALAKE_PATH=/app/datalake
      - DB_PATH=/app/datamart/datamart.db
    volumes:
      - shared-datalake:/app/datalake
      - shared-index:/app/indexer
      - shared-datamart:/app/datamart
      - shared-metadata:/app/metadata
    networks:
      - gutenberg-network
    depends_on:
      - activemq
      - hazelcast-1
      - hazelcast-2
      - hazelcast-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7002/status"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ===========================================================================
  # SEARCH SERVICE CLUSTER (3 replicas - read-heavy workload)
  # ===========================================================================
  
  search-1:
    build:
      context: .
      dockerfile: search-service/Dockerfile
    container_name: search-1
    environment:
      - NODE_ID=search-1
      - SERVER_PORT=7003
      - HAZELCAST_ENABLED=true
      - HAZELCAST_CLUSTER_NAME=stage3-cluster
      - HAZELCAST_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - INDEX_PATH=/app/indexer/tsv-index
      - DB_PATH=/app/datamart/datamart.db
    volumes:
      - shared-index:/app/indexer:ro
      - shared-datamart:/app/datamart:ro
    networks:
      - gutenberg-network
    depends_on:
      - hazelcast-1
      - hazelcast-2
      - hazelcast-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  search-2:
    build:
      context: .
      dockerfile: search-service/Dockerfile
    container_name: search-2
    environment:
      - NODE_ID=search-2
      - SERVER_PORT=7003
      - HAZELCAST_ENABLED=true
      - HAZELCAST_CLUSTER_NAME=stage3-cluster
      - HAZELCAST_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - INDEX_PATH=/app/indexer/tsv-index
      - DB_PATH=/app/datamart/datamart.db
    volumes:
      - shared-index:/app/indexer:ro
      - shared-datamart:/app/datamart:ro
    networks:
      - gutenberg-network
    depends_on:
      - hazelcast-1
      - hazelcast-2
      - hazelcast-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  search-3:
    build:
      context: .
      dockerfile: search-service/Dockerfile
    container_name: search-3
    environment:
      - NODE_ID=search-3
      - SERVER_PORT=7003
      - HAZELCAST_ENABLED=true
      - HAZELCAST_CLUSTER_NAME=stage3-cluster
      - HAZELCAST_MEMBERS=hazelcast-1:5701,hazelcast-2:5701,hazelcast-3:5701
      - INDEX_PATH=/app/indexer/tsv-index
      - DB_PATH=/app/datamart/datamart.db
    volumes:
      - shared-index:/app/indexer:ro
      - shared-datamart:/app/datamart:ro
    networks:
      - gutenberg-network
    depends_on:
      - hazelcast-1
      - hazelcast-2
      - hazelcast-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  gutenberg-network:
    driver: bridge
    name: gutenberg-distributed
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  # Message Broker
  activemq-data:
    name: gutenberg-activemq-data
  
  # Hazelcast (for persistence if needed)
  hazelcast-data-1:
    name: gutenberg-hazelcast-1
  hazelcast-data-2:
    name: gutenberg-hazelcast-2
  hazelcast-data-3:
    name: gutenberg-hazelcast-3
  
  # Shared storage
  shared-datalake:
    name: gutenberg-datalake
  shared-index:
    name: gutenberg-index
  shared-datamart:
    name: gutenberg-datamart
  shared-metadata:
    name: gutenberg-metadata
