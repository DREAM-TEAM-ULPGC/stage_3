version: '3.8'

services:
  # ===========================================
  # MESSAGE BROKER - Apache ActiveMQ
  # ===========================================
  activemq:
    image: rmohr/activemq:latest
    container_name: activemq
    restart: always
    ports:
      - "61616:61616"  # JMS/TCP protocol
      - "8161:8161"    # Web console
    environment:
      - ACTIVEMQ_ADMIN_LOGIN=admin
      - ACTIVEMQ_ADMIN_PASSWORD=admin
    networks:
      - search_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8161"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ===========================================
  # HAZELCAST CLUSTER NODES
  # ===========================================
  hazelcast1:
    image: hazelcast/hazelcast:5.3
    container_name: hazelcast1
    hostname: hazelcast1
    environment:
      - HZ_CLUSTERNAME=search-cluster
      - HZ_NETWORK_JOIN_TCPIP_ENABLED=true
      - HZ_NETWORK_JOIN_TCPIP_MEMBERS=hazelcast1,hazelcast2,hazelcast3
      - HZ_NETWORK_JOIN_MULTICAST_ENABLED=false
      - HZ_NETWORK_PUBLICADDRESS=hazelcast1:5701
      - JAVA_OPTS=-Dhazelcast.local.publicAddress=hazelcast1:5701
    ports:
      - "5701:5701"
    networks:
      - search_net

  hazelcast2:
    image: hazelcast/hazelcast:5.3
    container_name: hazelcast2
    hostname: hazelcast2
    environment:
      - HZ_CLUSTERNAME=search-cluster
      - HZ_NETWORK_JOIN_TCPIP_ENABLED=true
      - HZ_NETWORK_JOIN_TCPIP_MEMBERS=hazelcast1,hazelcast2,hazelcast3
      - HZ_NETWORK_JOIN_MULTICAST_ENABLED=false
      - HZ_NETWORK_PUBLICADDRESS=hazelcast2:5701
      - JAVA_OPTS=-Dhazelcast.local.publicAddress=hazelcast2:5701
    ports:
      - "5702:5701"
    networks:
      - search_net
    depends_on:
      - hazelcast1

  hazelcast3:
    image: hazelcast/hazelcast:5.3
    container_name: hazelcast3
    hostname: hazelcast3
    environment:
      - HZ_CLUSTERNAME=search-cluster
      - HZ_NETWORK_JOIN_TCPIP_ENABLED=true
      - HZ_NETWORK_JOIN_TCPIP_MEMBERS=hazelcast1,hazelcast2,hazelcast3
      - HZ_NETWORK_JOIN_MULTICAST_ENABLED=false
      - HZ_NETWORK_PUBLICADDRESS=hazelcast3:5701
      - JAVA_OPTS=-Dhazelcast.local.publicAddress=hazelcast3:5701
    ports:
      - "5703:5701"
    networks:
      - search_net
    depends_on:
      - hazelcast1

  # ===========================================
  # CRAWLER SERVICES (Ingestion)
  # ===========================================
  crawler1:
    build: ./crawler-service
    container_name: crawler1
    environment:
      - CRAWLER_ID=crawler1
      - ACTIVEMQ_URL=tcp://activemq:61616
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - DATALAKE_PATH=/data/datalake
      - REPLICATION_FACTOR=2
      - TOTAL_NODES=3
    volumes:
      - datalake_data:/data/datalake
    networks:
      - search_net
    depends_on:
      - activemq
      - hazelcast1

  crawler2:
    build: ./crawler-service
    container_name: crawler2
    environment:
      - CRAWLER_ID=crawler2
      - ACTIVEMQ_URL=tcp://activemq:61616
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - DATALAKE_PATH=/data/datalake
      - REPLICATION_FACTOR=2
      - TOTAL_NODES=3
    volumes:
      - datalake_data:/data/datalake
    networks:
      - search_net
    depends_on:
      - activemq
      - hazelcast1

  crawler3:
    build: ./crawler-service
    container_name: crawler3
    environment:
      - CRAWLER_ID=crawler3
      - ACTIVEMQ_URL=tcp://activemq:61616
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - DATALAKE_PATH=/data/datalake
      - REPLICATION_FACTOR=2
      - TOTAL_NODES=3
    volumes:
      - datalake_data:/data/datalake
    networks:
      - search_net
    depends_on:
      - activemq
      - hazelcast1

  # ===========================================
  # INDEXER SERVICES
  # ===========================================
  indexer1:
    build: ./indexer-service
    container_name: indexer1
    environment:
      - INDEXER_ID=indexer1
      - ACTIVEMQ_URL=tcp://activemq:61616
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - DATALAKE_PATH=/data/datalake
    volumes:
      - datalake_data:/data/datalake
    networks:
      - search_net
    depends_on:
      - activemq
      - hazelcast1

  indexer2:
    build: ./indexer-service
    container_name: indexer2
    environment:
      - INDEXER_ID=indexer2
      - ACTIVEMQ_URL=tcp://activemq:61616
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - DATALAKE_PATH=/data/datalake
    volumes:
      - datalake_data:/data/datalake
    networks:
      - search_net
    depends_on:
      - activemq
      - hazelcast1

  indexer3:
    build: ./indexer-service
    container_name: indexer3
    environment:
      - INDEXER_ID=indexer3
      - ACTIVEMQ_URL=tcp://activemq:61616
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - DATALAKE_PATH=/data/datalake
    volumes:
      - datalake_data:/data/datalake
    networks:
      - search_net
    depends_on:
      - activemq
      - hazelcast1

  # ===========================================
  # SEARCH SERVICES
  # ===========================================
  search1:
    build: ./search-service
    container_name: search1
    environment:
      - SEARCH_ID=search1
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - SERVER_PORT=8080
    expose:
      - "8080"
    networks:
      - search_net
    depends_on:
      - hazelcast1

  search2:
    build: ./search-service
    container_name: search2
    environment:
      - SEARCH_ID=search2
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - SERVER_PORT=8080
    expose:
      - "8080"
    networks:
      - search_net
    depends_on:
      - hazelcast1

  search3:
    build: ./search-service
    container_name: search3
    environment:
      - SEARCH_ID=search3
      - HAZELCAST_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - SERVER_PORT=8080
    expose:
      - "8080"
    networks:
      - search_net
    depends_on:
      - hazelcast1

  # ===========================================
  # LOAD BALANCER - Nginx
  # ===========================================
  nginx:
    image: nginx:latest
    container_name: search_load_balancer
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - search_net
    depends_on:
      - search1
      - search2
      - search3

# ===========================================
# NETWORKS
# ===========================================
networks:
  search_net:
    driver: bridge

# ===========================================
# VOLUMES
# ===========================================
volumes:
  datalake_data:
    driver: local
